---
layout: post
title: Removing SearchProtect32.dll malware the hard way
date: 2014-08-06 21:33:05.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Did you know?
tags:
- malware
- SearchProtect32.dll
meta:
  _edit_last: '1'
  _publicize_facebook_user: https://www.facebook.com/lazarconstantincosmin
  _publicize_twitter_user: "@CosminLazar"
  _yoast_wpseo_focuskw: Remove SearchProtect32.dll malware
  _yoast_wpseo_title: Remove SearchProtect32.dll malware
  _yoast_wpseo_metadesc: My story of detecting and cleaning up the SearchProtect32.dll
    and istart.webssearches.com malware
  _yoast_wpseo_linkdex: '67'
  _yoast_wpseo_opengraph-description: My story of detecting and cleaning up the istart.webssearches.com
    malware
  _yoast_wpseo_google-plus-description: My story of detecting and cleaning up the
    istart.webssearches.com malware
  _wpas_done_all: '1'
  _wpas_skip_5526398: '1'
  _wpas_skip_5526404: '1'
  _wpas_skip_6755022: '1'
  _wpas_skip_7497947: '1'
author:
  login: admin
  email: cosminconstantinlazar@gmail.com
  display_name: Cosmin Lazar
  first_name: Cosmin
  last_name: Lazar
permalink: "/did-you-know/removing-malware-hard-way.html"
excerpt: My story of detecting and cleaning up the SearchProtect32.dll and istart.webssearches.com
  malware
---
<p>The days when you could install some software by just clicking the Next button like a madman are long gone. Back in the days, software programs were simple, you would download their setup, install it, and happily use it afterwards. Today, installing a piece of software is the most attention demanding thing in the world, you have to carefully read every step, make sure you opt out of all the additional programs/malware/toolbars/atomic bombs they are trying to shovel on your throat (what, you don't believe me? try downloading and installing java, you are in for an extra toolbar in your favorite browser).</p>
<p>In most of the cases, even if you accidentally install one of these extra goodies, you can uninstall them via the windows uninstaller, or from the browsers extension page. However, I stumbled upon a browser extension which actively refused my efforts to make it go away.</p>
<h2>Initial symptoms:</h2>
<ul>
<li>
<div>My browser start page was always <em><strong>http://istart.webssearches.com</strong></em></div>
</li>
<li>Starting the browser in incognito mode was no longer possible</li>
<li>When trying to start the browser in incognito mode, it would always open a new tab pointing to <em><strong>http://istart.webssearches.com</strong></em></li>
<li>Some websites started displaying obtrusive ads, sometime overlaying the content of the page</li>
</ul>
<h2>Initial countermeasures:</h2>
<ul>
<li>Went through the browser extension page and removed the <strong><em>Quick Start</em></strong> extension (as it was the only one I didn't knew)</li>
<li>Went through the windows uninstaller but couldn't find any suspicious programs (some people were able to find a program called <em><strong>RSHP</strong> </em>which when uninstalled fixes the issue)</li>
<li>Went to the browser settings and reset the start page and search provider</li>
</ul>
<p>After this first round of countermeasures, I managed to get rid of the initial <em><strong>http://istart.webssearches.com</strong></em> browser page, however opening an incognito window would still open a new tab pointed to <em><strong>http://istart.webssearches.com</strong></em>. The obtrusive ads were still showing up, thus I concluded my job was not done.</p>
<h2>Second wave of countermeasures:</h2>
<p>At this point I tried all the easy ways out of the problem, and it was time to dive a little bit deeper.</p>
<p>Started <a title="Process Monitor" href="http://technet.microsoft.com/en-us/sysinternals/bb896645.aspx" target="_blank">Process Monitor</a> and pointed it to the chrome.exe processes. After scanning through the generated activity, I encountered something out of the ordinary:</p>
<p>[caption id="attachment_221" align="aligncenter" width="943"]<a href="http://everydaylifein.net/wp-content/uploads/2014/08/DetectedSupTab.png"><img class="size-full wp-image-221" src="{{ site.baseurl }}/assets/*[D*[D*[D*[D*[D*[D*[D*[D/2014/08/DetectedSupTab.png" alt="Suspicious activity" width="943" height="186" /></a> Suspicious activity[/caption]</p>
<h3><strong>SearchProtect32.dll</strong></h3>
<p><strong> <em>SearchProtect32.dll</em></strong> is being loaded into memory, and since I don't use protection when I search, I figured this is a promising lead to follow. Going to the <em><strong>C:\Program Files (x86)\SupTab</strong></em> I could find a file called <em><strong>RSHP.exe</strong></em>, now I was convinced I found the criminal.</p>
<h3>Why does it get loaded into memory?</h3>
<p>Started looking around the <em>LoadImage </em>operation to get some context, and I found a registry query for <em><strong>AppInit_DLLs</strong></em>, opening the registry value I found it contains "<em><strong>C:\PROGRA~2\SupTab\SEARCH~1.DLL</strong></em>". This is what causes the <em><strong>SearchProtect32.dll</strong></em> to be loaded,  but, why?</p>
<p>After doing some reading about <em><strong>AppInit_DLLs</strong></em> everything made sense. The <a title="official Microsoft description" href="http://support.microsoft.com/kb/197571" target="_blank">official Microsoft description </a>for <strong><em>AppInit_DLLs</em></strong> states: "<em>All the DLLs that are specified in this value are loaded by each Microsoft Windows-based application that is running in the current log on session</em>", wait, what have I just read? cannot comprehend...</p>
<p>Why would you provide such a functionality, why call it <em><strong>AppInit_DLLs</strong></em> when you can more intuitively call it <em><strong>MalwareWithoutBorders</strong> </em>or <em><strong>PleaseInsertPathToMalware</strong></em>?</p>
<p>Relax they said, "<em>Typically, only the Administrators group and the LocalSystem account have write access to the key that contains the AppInit_DLLs value. </em>", BUT, what if I told you that most installer software requires administrator privileges to run??</p>
<h3>Cleaning up</h3>
<p>Searched for some more documentation and found <a title="this description" href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd744762(v=vs.85).aspx" target="_blank">this description</a> of the whole process.</p>
<p>At this point, my mind is blown and I just want to get this over with, and this is what I've done:</p>
<ul>
<li>Disabled dll loading by setting <span style="font: 14px/20px 'Segoe UI', 'Lucida Grande', Verdana, Arial, Helvetica, sans-serif; color: #2a2a2a; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; display: inline !important; white-space: normal; -webkit-text-stroke-width: 0px;"><em><strong>LoadAppInit_DLLs</strong></em><span class="Apple-converted-space"> </span></span>to <em><strong>0 (zero)</strong></em></li>
<li>Required the potentially future loaded dlls to be signed with a digital certificate, by creating a value of type <em>DWORD</em>, naming it <em><strong><span style="font-variant: normal; font-size: 14px; line-height: 20px; font-family: 'Segoe UI', 'Lucida Grande', Verdana, Arial, Helvetica, sans-serif; color: #2a2a2a; text-transform: none; text-indent: 0px; letter-spacing: normal; word-spacing: 0px; float: none; white-space: normal; -webkit-text-stroke-width: 0px; display: inline !important;">RequireSignedAppInit_DLLs</span></strong></em> and set it to <strong><em>1 (one)</em></strong></li>
<li>Cleared the value of <strong><em>AppInit_DLLs</em></strong></li>
<li><em>I did this with a bitter taste in my mouth, as I know that any program running under admin privileges (e.g.:  malware installer) can change them as they desire, rendering my efforts futile</em></li>
<li>Removed the <strong><em>C:\Program Files (x86)\SupTab</em></strong> directory</li>
<li><em>Of course I couldn't remove the <strong>SupTab</strong> directory as the damn dll is contained in ... ... probably most of the processes I have running at the moment (thanks M$), therefore I had to schedule the deletion of the file on the next boot (I used <a title="this" href="https://gist.github.com/marnix/7565364" target="_blank">this</a> to schedule the deletion, you can read more about removing locked files <a title="here" href="http://blogs.technet.com/b/heyscriptingguy/archive/2013/10/19/weekend-scripter-use-powershell-and-pinvoke-to-remove-stubborn-files.aspx" target="_blank">here</a>).</em></li>
<li>Reboot</li>
</ul>
<p>Who is responsible for this great peace of software you might ask, as it turns out, all the files were digitally signed and here's a print screen of the digital signature information</p>
<p>[caption id="attachment_227" align="aligncenter" width="419"]<a href="http://everydaylifein.net/wp-content/uploads/2014/08/DigitalSignature.png"><img class="size-full wp-image-227" src="{{ site.baseurl }}/assets/*[D*[D*[D*[D*[D*[D*[D*[D/2014/08/DigitalSignature.png" alt="Digital signature information" width="419" height="492" /></a> Digital signature information[/caption]</p>
<p>&nbsp;</p>
<p>If you feel like writing an email to <em><strong>chloezhangling@gmail.com</strong></em> and thank the very author of this rubbish piece of software, I won't judge...</p>
