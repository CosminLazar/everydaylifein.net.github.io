---
layout: post
title: Modifying the project during NuGet package installation and removal
date: 2015-02-26 20:54:42.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ".NET"
tags:
- BuildAction
- CopyToOutputDirectory
- nuget
- script
- Visual Studio
meta:
  _edit_last: '1'
  _publicize_facebook_user: https://www.facebook.com/lazarconstantincosmin
  _publicize_twitter_user: "@CosminLazar"
  _oembed_6d9f0a100f805063936a2dc6ff9f4a32: "{{unknown}}"
  _yoast_wpseo_focuskw: NuGet install.ps1 CopyToOutputDirectory BuildAction
  _yoast_wpseo_title: Change CopyToOutputDirectory, BuildAction from Install.ps1
  _yoast_wpseo_metadesc: How to change CopyToOutputDirectory, BuildAction and other
    project properties from NuGet package scripts (Init.ps1, Install.ps1, Uninstall.ps1)
  _yoast_wpseo_linkdex: '69'
  _yoast_wpseo_opengraph-description: How to change CopyToOutputDirectory, BuildAction
    and other project properties from NuGet package scripts (Init.ps1, Install.ps1,
    Uninstall.ps1)
  _yoast_wpseo_twitter-description: How to change CopyToOutputDirectory, BuildAction
    and other project properties from NuGet package scripts (Init.ps1, Install.ps1,
    Uninstall.ps1)
  _wpas_done_all: '1'
  _wpas_mess: Modifying the project during NuGet package installation and removal
    http://wp.me/p49ir3-5f
  _yoast_wpseo_focuskw_text_input: NuGet install.ps1 CopyToOutputDirectory BuildAction
  _yoast_wpseo_content_score: '90'
  _yoast_wpseo_primary_category: ''
  _wpas_skip_5526398: '1'
  _wpas_skip_5526404: '1'
  _wpas_skip_6755022: '1'
  _wpas_skip_7497947: '1'
author:
  login: admin
  email: cosminconstantinlazar@gmail.com
  display_name: Cosmin Lazar
  first_name: Cosmin
  last_name: Lazar
permalink: "/netframework/modifying-the-project-during-nuget-package-installation-and-removal.html"
---
<p style="text-align: left;">By default NuGet does a great job installing and referencing all the assemblies present in the '<em><strong>lib</strong></em>' directory of the NuGet package. Furthermore, if you have other files which need to be added to the solution, you can simply add them to the '<em><strong>content</strong></em>' directory of the package. The files added to the '<em><strong>content</strong></em>' directory will be added to the solution with the following properties:</p>
<ul style="text-align: left;">
<li>BuildAction - Content</li>
<li>CopyToOutputDirectory - Do not copy</li>
</ul>
<p style="text-align: left;"><em>This is extremely nice if you have images, unmanaged dlls, or other things that just need to be added to the solution, and not referenced.</em></p>
<p style="text-align: left;">However, there are times when the default behavior is not enough, and you need control over how your items get added to the project (e.g. if you need to have CopyToOutputDirectory=CopyIfNewer).</p>
<h2 style="text-align: left;">Running scripts when installing the package</h2>
<p style="text-align: left;">You will need to add a <em><strong>Install.ps1</strong></em> script to your package. You can read more on how to do that <a title="Running PowerShell scripts during NuGet package installation and removal" href="http://everydaylifein.net/netframework/running-powershell-scripts-during-nuget-package-installation-and-removal.html" target="_blank" rel="noopener">here</a>.</p>
<p style="text-align: left;">Now that you added <strong><em>Install.ps1 </em></strong>to your package, it's time to change some values here and there. Of course, there are several ways this behavior can be achieved, I will start with how <strong>NOT</strong> to do it, and continue with how to do it.</p>
<h3 style="text-align: left;">How <strong>NOT</strong> to do it</h3>
<p style="text-align: left;">While trying to figure out myself how to achieve this, I found <a href="http://stackoverflow.com/a/21161498" target="_blank" rel="noopener">this</a> answer on stackoverflow.com. Unfortunately, I was hasty enough to take that solution as "good enough", and didn't scrolled down a few more answers (spoiler alert: one of them contains the correct way of doing it).</p>
<p style="text-align: left;">I adjusted the PowerShell code with a more "mean" xquery and got this bad boy</p>
<p>[gist id=99f2b78057f06c8f9b18 file=WrongInstall.ps1]</p>
<p>The above script loads the project file from the disk, performs some changes to it, and then flushes it back to the disk. Mission accomplished, however, you are actually changing the project "behind the scenes", and big surprise, Visual Studio is not entirely happy about it:</p>
<p>[caption id="attachment_343" align="aligncenter" width="300"]<a href="http://everydaylifein.net/wp-content/uploads/2015/02/SaveAsDiscard.png"><img class="size-medium wp-image-343" src="{{ site.baseurl }}/assets/*[D*[D*[D*[D*[D*[D*[D*[D/2015/02/SaveAsDiscard-300x112.png" alt="Project modified outside Visual Studio" width="300" height="112" /></a> Project modified outside Visual Studio[/caption]</p>
<p><em><strong>Q</strong>: Should I Save, Discard, Overwrite, Ignore?</em></p>
<p><em><strong>A</strong>: Can I chose more than one option?</em></p>
<p>If you saved all your changes before running the package installation, in most of the cases you would be able to click <em><strong>Discard</strong></em><br />
and get away with it, but not all the times. What's left, is <em><strong>Save As</strong></em> and later on performing a merge of the two project files (highly uncool). Moreover, I wonder how this will work if there are errors while installing the package and a rollback is needed.</p>
<h3 style="text-align: left;">How to do it</h3>
<p style="text-align: left;">The parameters that your Install.ps1 script is receiving are:</p>
<p style="text-align: left;">[gist id=78d99c4d57f9de097fd2 file=NugetPowershellScriptHeader.ps1]</p>
<p><em>You can review the details of each parameter <a href="param($installPath,%20$toolsPath, $package, $project)" target="_blank" rel="noopener">here</a>.</em></p>
<p>The <em><strong>$project</strong></em> is a reference to the <a title="EnvDTE - official msdn documentation" href="https://msdn.microsoft.com/en-us/library/envdte.dte.aspx" target="_blank" rel="noopener">EnvDTE </a>project the package is being installed into. This means that you get complete control over the project file in a standard way.</p>
<p>Here are a few examples on how to use it:</p>
<h4>CopyToOutputDirectory</h4>
<p>Given the following project structure</p>
<p><a href="http://everydaylifein.net/wp-content/uploads/2015/02/RoccatSolutionDLL.png"><img class="aligncenter size-full wp-image-345" src="{{ site.baseurl }}/assets/*[D*[D*[D*[D*[D*[D*[D*[D/2015/02/RoccatSolutionDLL.png" alt="RoccatSolutionDLL" width="178" height="114" /></a></p>
<p>Changing the <em><strong>CopyToOutputDirectory</strong></em> property of the talkfx-c.dll can be done with the following construct</p>
<p>[gist id=78d99c4d57f9de097fd2 file=ChangingCopyToOutputDirectory.ps1]</p>
<p><em>Note: You need to work your way down the project structure hierarchy until you reach the item you are after (in this case CroccatTalkWrapper/win32-x86/talkfx-c.dll)</em></p>
<p>The possible values for <em><strong>CopyToOutputDirectory</strong></em> are</p>
<ul>
<li><strong><em>0</em></strong> = Do not copy</li>
<li><em><strong>1</strong></em> = Copy always</li>
<li><em><strong>2</strong></em> = Copy if newer</li>
</ul>
<h4>BuildAction</h4>
<p>Keeping the same project structure as above</p>
<p>[gist id=78d99c4d57f9de097fd2 file=ChangingBuildAction.ps1]</p>
<p>Standard <strong><em>BuildAction</em></strong> values are:</p>
<ul>
<li><em><strong>0</strong></em> = None</li>
<li><em><strong>1</strong></em> = Compile</li>
<li><em><strong>2</strong></em> = Content</li>
<li><em><strong>3</strong></em> = EmbeddedResource</li>
</ul>
<h4>Testing</h4>
<p>If you need to test your <em><strong>$project</strong></em> manipulations, you can do it in the Visual Studio Package Manager Console</p>
<p>[gist id=78d99c4d57f9de097fd2 file=TestingTheProjectInPackageManagerConsole.ps1]</p>
<p>Now you can test all your manipulations in the console.</p>
<h4>Compatibility</h4>
<p>Starting with Visual Studio 2017 install.ps1 and uninstall.ps1 are no longer supported (<a href="http://blog.nuget.org/20170316/NuGet-now-fully-integrated-into-MSBuild.html">read more</a>).</p>
